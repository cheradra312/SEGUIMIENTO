<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Estudio para Oposición</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .tick-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px; /* Ancho para el tick y la fecha */
        }
        .tick-box {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            cursor: pointer;
        }
        
        /* --- TICK BOX COLORS (RESTORED) --- */
        /* Assigned (not studied) color */
        .tick-box.assigned { background-color: #f1f5f9; border-color: #9ca3af; } /* gray-100 bg, gray-400 border */

        /* Security Level Colors for Studied topics */
        .tick-box.studied.security-20 { background-color: #fecaca; border-color: #ef4444; } /* red-200 bg, red-500 border */
        .tick-box.studied.security-40 { background-color: #fed7aa; border-color: #f97316; } /* orange-200 bg, orange-500 border */
        .tick-box.studied.security-60 { background-color: #fef08a; border-color: #eab308; } /* yellow-200 bg, yellow-500 border */
        .tick-box.studied.security-80 { background-color: #d9f99d; border-color: #84cc16; } /* lime-200 bg, lime-500 border */
        .tick-box.studied.security-100 { background-color: #bbf7d0; border-color: #22c55e; } /* green-200 bg, green-500 border */

        /* --- TOPIC CARD BACKGROUND COLORS (NEW) --- */
        .topic-card.status-not-studied { background-color: #ffffff; } /* white */
        .topic-card.status-vuelta-1 { background-color: #fefce8; }    /* yellow-50 */
        .topic-card.status-vuelta-2 { background-color: #fef9c3; }    /* yellow-100 */
        .topic-card.status-vuelta-3 { background-color: #ecfccb; }    /* lime-100 */
        .topic-card.status-vuelta-4 { background-color: #dcfce7; }    /* green-100 */
        .topic-card.status-vuelta-5 { background-color: #ccfbf1; }    /* teal-100 */


        .tick-box .tick-mark { display: none; }

        .tick-box.studied .tick-mark {
            display: block; width: 8px; height: 14px;
            border: solid white; border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
        .tick-box.assigned .tick-mark {
            display: block; width: 10px; height: 10px;
            border: 2px solid white; border-radius: 50%;
            transform: none; background-color: transparent;
        }

        .tick-date {
            font-size: 0.65rem; color: #6b7280;
            margin-top: 2px; height: 1em;
        }
        .topic-card:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .topic-full-name { display: none; margin-left: 8px; font-size: 0.875rem; }
        body.show-full-names .topic-full-name { display: inline; }

        .header-container { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .header-container.is-collapsible { cursor: pointer; }
        .header-title-wrapper { display: flex; align-items: center; flex-grow: 1; min-width: 0; }
        .topic-text-container { flex-grow: 1; }
        
        #login-modal, #notes-modal-backdrop {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.3s;
        }
        #login-modal.hidden, #notes-modal-backdrop.hidden { opacity: 0; pointer-events: none; }

        .collapsible-content { max-height: 5000px; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible.collapsed > .collapsible-content { max-height: 0; margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; }
        .toggle-icon { transition: transform 0.3s ease; flex-shrink: 0; margin-right: 0.75rem; color: #6b7280; }
        .collapsible.collapsed .toggle-icon { transform: rotate(-90deg); }

        .notes-icon { cursor: pointer; color: #cbd5e1; transition: color 0.2s; }
        .notes-icon:hover { color: #64748b; }
        .notes-icon.has-notes { color: #facc15; }
        .notes-icon.has-notes:hover { color: #eab308; }

        .security-selector {
            position: absolute; background: white; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 10; padding: 4px; display: flex; flex-direction: column; gap: 2px;
            top: 100%; left: 50%; transform: translateX(-50%); margin-top: 4px;
        }
        .security-option {
            padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
            font-weight: 500; text-align: center;
        }
        .security-option:hover { background-color: #f1f5f9; }

        /* Color Theming */
        .color-adm { color: #b45309; } .color-aguas { color: #0369a1; } .color-costas { color: #0e7490; }
        .color-infra { color: #4b5563; } .color-trans { color: #059669; } .color-ma { color: #15803d; }

        /* --- STYLES FOR SUB-BLOCKS LAYOUT --- */
        .sub-blocks-container {
            display: block;
        }

        body:not(.show-full-names) .sub-blocks-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        body:not(.show-full-names) .sub-block.collapsible.collapsed > .collapsible-content {
            max-height: 5000px; /* Show content in compact view */
        }
        
        body:not(.show-full-names) .sub-block .is-collapsible {
            cursor: default; /* Not clickable in compact view */
        }

        body:not(.show-full-names) .sub-block .toggle-icon {
            display: none; /* Hide collapse icon in compact view */
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="login-modal">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-center">Bienvenido</h2>
            <p class="text-gray-600 mb-6 text-center">Introduce un nombre de usuario o ID para cargar tu progreso.</p>
            <form id="login-form">
                <input type="text" id="username-input" placeholder="Tu nombre de usuario" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors font-semibold">Empezar</button>
            </form>
        </div>
    </div>
    
    <div id="notes-modal-backdrop" class="hidden">
        <div id="notes-modal-container" class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <h3 id="notes-modal-title" class="text-xl font-bold mb-4"></h3>
            <textarea id="notes-modal-textarea" class="w-full h-48 p-2 border border-gray-300 rounded-lg" placeholder="Escribe tus notas aquí..."></textarea>
            <div class="mt-4 flex justify-end gap-3">
                <button id="notes-modal-cancel" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="notes-modal-save" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="container mx-auto p-4 md:p-8 hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-800">Seguimiento de Estudio</h1>
            <p class="text-lg text-slate-500 mt-2">Cuerpo de Ingenieros de Caminos, Canales y Puertos del Estado</p>
            <div id="user-info" class="mt-4 text-sm text-gray-500"></div>
            <div id="connection-status" class="mt-2 text-sm font-semibold h-5"></div>
            <div class="mt-6 flex flex-wrap justify-center items-center gap-4">
                <button id="toggle-names-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-medium">Mostrar Nombres</button>
                <button id="calc-prob-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-sm font-medium"><i class="fas fa-calculator mr-2"></i>Calcular Probabilidad</button>
                <button id="collapse-all-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors shadow-sm font-medium">Plegar Todo</button>
                <button id="expand-all-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors shadow-sm font-medium">Desplegar Todo</button>
                <div class="flex items-center gap-2">
                    <label for="vuelta-selector" class="font-medium text-slate-700">Ver Vuelta:</label>
                    <select id="vuelta-selector" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                </div>
            </div>
        </header>

        <div class="bg-white rounded-lg shadow-md mb-8 overflow-x-auto">
            <table id="top-summary-table" class="w-full text-sm text-left text-slate-600"></table>
        </div>

        <main id="syllabus-container"></main>

        <footer class="text-center mt-12 py-4">
            <p class="text-sm text-gray-500">Aplicación generada para el seguimiento de estudio.</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKXzSmQ9F1M4W59Vyalu3CWdKFsh7dOmE",
            authDomain: "costas-304b9.firebaseapp.com",
            projectId: "costas-304b9",
            storageBucket: "costas-304b9.appspot.com",
            messagingSenderId: "251850800414", 
            appId: "1:251850800414:web:435e20e5305881732e5d0f",
            measurementId: "G-C2NTL72PZH"
        };

        let db, sessionId;
        let plannerState = {};
        let progressByTopic = {};
        let state = { rounds: [] }; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-planner-app';
        
        const BLOCKS_CONFIG = {
            "Organización y Funcionamiento de la Administración Pública": { abbr: "ADM", icon: "fa-gavel", color: "color-adm", calcId: 'admin' },
            "A.1) Aguas y Obras Hidráulicas": { abbr: "AGUAS", icon: "fa-tint", color: "color-aguas", calcId: 'aguas' },
            "A.2) Puertos y Costas": { abbr: "COSTAS", icon: "fa-water", color: "color-costas", calcId: 'aguas' },
            "B.1) Carreteras": { abbr: "CARR", icon: "fa-road", color: "color-infra", calcId: 'carreteras' },
            "B.2) Ferrocarriles": { abbr: "FERR", icon: "fa-train", color: "color-infra", calcId: 'carreteras' },
            "C.1) Transportes y Movilidad": { abbr: "TRANS", icon: "fa-bus", color: "color-trans", calcId: 'transportes' },
            "C.2) Medio Ambiente": { abbr: "MA", icon: "fa-leaf", color: "color-ma", calcId: 'transportes' }
        };
        
        const syllabus = {
            "Materias comunes": {
                "Organización y Funcionamiento de la Administración Pública": [
                    { id: 1, text: "La Constitución Española de 1978. Estructura, principios constitucionales y valores superiores. Los derechos y libertades fundamentales. La reforma constitucional." },
                    { id: 2, text: "La estructura de poderes del Estado. Poder legislativo, poder ejecutivo y poder judicial. La Corona." },
                    { id: 3, text: "Fuentes del ordenamiento jurídico administrativo. La Constitución. Los tratados internacionales. La ley. El reglamento. Otras fuentes del derecho administrativo." },
                    { id: 4, text: "La Administración General del Estado. Órganos superiores y órganos directivos. La organización central. La organización periférica. Delegados y Subdelegados del Gobierno. Especial referencia al Ministerio de Transportes y Movilidad Sostenible." },
                    { id: 5, text: "Las Comunidades Autónomas. El proceso autonómico y el sistema de distribución de competencias entre la Administración General del Estado y las Comunidades Autónomas. Los Estatutos de Autonomía y la organización institucional de las Comunidades Autónomas. La Administración Local: entidades que la integran." },
                    { id: 6, text: "La Unión Europea y sus tratados constitutivos. Sistema institucional. Fuentes del Derecho de la Unión y su trasposición al ordenamiento jurídico español. Políticas comunes." },
                    { id: 7, text: "El régimen jurídico de las Administraciones Públicas y su regulación. Principios que rigen las relaciones de las Administraciones Públicas. Actividad de las administraciones públicas: derechos y deberes de los ciudadanos." },
                    { id: 8, text: "La Gobernanza Pública y el Gobierno Abierto. Concepto y principios informadores del Gobierno Abierto en España." },
                    { id: 9, text: "El acto administrativo: concepto, elementos y clases. Requisitos. Motivación, notificación y publicación. Nulidad y anulabilidad de los actos. Disposiciones administrativas generales: jerarquía y competencia. Publicidad e inderogabilidad." },
                    { id: 10, text: "El procedimiento administrativo común y sus fases. Concepto de persona interesada. Iniciación y ordenación del procedimiento, instrucción, finalización. El silencio administrativo. Ejecución." },
                    { id: 11, text: "Revisión de los actos en vía administrativa. Recursos administrativos: concepto, naturaleza y clases. Revisión de oficio. La jurisdicción contencioso-administrativa. El recurso contencioso-administrativo." },
                    { id: 12, text: "La responsabilidad patrimonial de la Administración. Regulación, Principios y procedimientos. La indemnización: concepto y naturaleza. La responsabilidad civil y penal de las autoridades y personal al servicio de las Administraciones Públicas. La potestad sancionadora. Regulación, naturaleza y principios rectores de la potestad sancionadora y del procedimiento sancionador." },
                    { id: 13, text: "La expropiación forzosa. Actos administrativos previos de expropiación. Justiprecio. Jurado Provincial de Expropiación. Pago y ocupación de bienes. Inscripción registral." },
                    { id: 14, text: "Los contratos del sector público (1): ámbito subjetivo y objetivo de aplicación de la legislación de contratación del sector público. Disposiciones comunes sobre la contratación del sector público. Los sujetos parte en el contrato. Tipología de contratos." },
                    { id: 15, text: "Los contratos del sector público (II). Actuaciones administrativas. Preparación: consultas, expediente de contratación, pliegos. Adjudicación: normas generales y formas de adjudicación. Perfección, formalización y extinción de los contratos. Ejecución." },
                    { id: 16, text: "El modelo de Función Pública del Real Decreto Legislativo 5/2015, de 30 de octubre, por el que se aprueba el texto refundido de la Ley del Estatuto Básico del Empleado Público. Características generales. El personal al servicio de las Administraciones Públicas: clasificación, derechos y deberes." },
                    { id: 17, text: "Principios, políticas y medidas de igualdad de género y contra la violencia de género. Normativa vigente en el ordenamiento español y en el de la Unión Europea, con especial referencia al III Plan para la Igualdad de Género en la Administración General del Estado y en sus Organismos Autónomos vinculados o dependientes de ella. Políticas de igualdad de trato y no discriminación de las personas LGTBI. Políticas dirigidas a la atención a personas con discapacidad y a las personas en situación de dependencia." }
                ]
            },
            "Materias específicas": {
                "A) Aguas y Obras Hidráulicas, Puertos y Costas": {
                    "A.1) Aguas y Obras Hidráulicas": Array.from({length: 28}, (_,i) => ({id: i+1, text: `Tema A.1.${i+1}`})),
                    "A.2) Puertos y Costas": Array.from({length: 20}, (_,i) => ({id: i+1, text: `Tema A.2.${i+1}`}))
                },
                "B) Infraestructuras de Transporte": {
                    "B.1) Carreteras": Array.from({length: 24}, (_,i) => ({id: i+1, text: `Tema B.1.${i+1}`})),
                    "B.2) Ferrocarriles": Array.from({length: 22}, (_,i) => ({id: i+1, text: `Tema B.2.${i+1}`}))
                },
                "C) Transportes, Movilidad y Medio Ambiente": { 
                    "C.1) Transportes y Movilidad": Array.from({length: 21}, (_,i) => ({id: i+1, text: `Tema C.1.${i+1}`})),
                    "C.2) Medio Ambiente": Array.from({length: 15}, (_,i) => ({id: i+1, text: `Tema C.2.${i+1}`}))
                }
            }
        };

        window.onload = async () => {
            try {
                initializeApp(firebaseConfig);
                db = getFirestore();
                const loginModal = document.getElementById('login-modal');
                const loginForm = document.getElementById('login-form');
                let user = sessionStorage.getItem('username');
                if (!user) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const userFromUrl = urlParams.get('user');
                    if (userFromUrl) {
                        user = userFromUrl;
                        sessionStorage.setItem('username', user);
                    }
                }
                if (user) await startApp(user);
                else {
                    loginModal.style.display = 'flex'; 
                    loginForm?.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const username = document.getElementById('username-input').value.trim();
                        if (username) {
                            sessionStorage.setItem('username', username);
                            await startApp(username);
                        }
                    });
                }
            } catch (error) { console.error("Error initializing:", error); }
        };

        async function startApp(username) {
            sessionId = username;
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden');
            
            setupVueltaSelector();
            setupEventListeners();
            renderSyllabus(); 
            await loadProgress(); 
        }

        function setupEventListeners() {
            document.getElementById('vuelta-selector').addEventListener('change', updateAllCounters);
            document.getElementById('toggle-names-btn').addEventListener('click', () => {
                document.body.classList.toggle('show-full-names');
                const btn = document.getElementById('toggle-names-btn');
                btn.textContent = document.body.classList.contains('show-full-names') ? 'Ocultar Nombres' : 'Mostrar Nombres';
            });
            document.getElementById('collapse-all-btn').addEventListener('click', () => toggleAll(true));
            document.getElementById('expand-all-btn').addEventListener('click', () => toggleAll(false));
            document.getElementById('calc-prob-btn').addEventListener('click', openCalculator);
            document.getElementById('notes-modal-cancel').addEventListener('click', hideNotesModal);
            document.getElementById('notes-modal-backdrop').addEventListener('click', (e) => {
                if (e.target === document.getElementById('notes-modal-backdrop')) hideNotesModal();
            });
        }
        
        function setupVueltaSelector() {
            const selector = document.getElementById('vuelta-selector');
            selector.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Vuelta ${i}`;
                selector.appendChild(option);
            }
        }

        function renderSyllabus() {
            const container = document.getElementById('syllabus-container');
            container.innerHTML = ''; 
            for (const topLevelTitle in syllabus) {
                const topLevelBlock = document.createElement('div');
                topLevelBlock.className = 'mt-8';
                topLevelBlock.appendChild(createHeader(2, topLevelTitle));
                const mainBlocks = syllabus[topLevelTitle];
                for (const mainBlockTitle in mainBlocks) {
                    const mainBlockEl = document.createElement('div');
                    mainBlockEl.className = 'main-block mt-6 ml-4 collapsible collapsed';
                    mainBlockEl.appendChild(createHeader(3, mainBlockTitle, true));
                    const mainBlockContent = document.createElement('div');
                    mainBlockContent.className = 'collapsible-content';
                    const subBlocksOrTopics = mainBlocks[mainBlockTitle];
                    if (Array.isArray(subBlocksOrTopics)) {
                        subBlocksOrTopics.forEach(topic => mainBlockContent.appendChild(createTopicElement(topic, mainBlockTitle)));
                    } else {
                        const subBlocksContainer = document.createElement('div');
                        subBlocksContainer.className = 'sub-blocks-container';
                        for (const subBlockKey in subBlocksOrTopics) {
                            const subBlockEl = document.createElement('div');
                            subBlockEl.className = 'sub-block collapsible collapsed';
                            
                            const subBlockHeader = createHeader(4, subBlockKey, true);
                            const subBlockTopics = document.createElement('div');
                            subBlockTopics.className = 'collapsible-content';

                            subBlocksOrTopics[subBlockKey].forEach(topic => subBlockTopics.appendChild(createTopicElement(topic, subBlockKey)));
                            
                            subBlockEl.appendChild(subBlockHeader);
                            subBlockEl.appendChild(subBlockTopics);
                            subBlocksContainer.appendChild(subBlockEl);
                        }
                        mainBlockContent.appendChild(subBlocksContainer);
                    }
                    mainBlockEl.appendChild(mainBlockContent);
                    topLevelBlock.appendChild(mainBlockEl);
                }
                container.appendChild(topLevelBlock); 
            }
        }

        function createHeader(level, title, isCollapsible = false) {
            const headerWrapper = document.createElement('div');
            headerWrapper.className = 'header-container';
             if (isCollapsible) {
                headerWrapper.classList.add('is-collapsible');
                headerWrapper.addEventListener('click', (e) => {
                    if (e.target.closest('.header-counters')) return;
                    if (headerWrapper.closest('.sub-block') && !document.body.classList.contains('show-full-names')) {
                        return;
                    }
                    headerWrapper.parentElement.classList.toggle('collapsed');
                });
            }
            const titleWrapper = document.createElement('div');
            titleWrapper.className = 'header-title-wrapper';
            if (isCollapsible) {
                const icon = document.createElement('div');
                icon.className = 'toggle-icon';
                icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>`;
                titleWrapper.appendChild(icon);
            }
            const titleEl = document.createElement(`h${level}`);
            const styles = {
                2: 'text-2xl font-bold text-slate-800 border-b-2 border-slate-300 pb-2', 
                3: 'text-xl font-semibold text-slate-700',
                4: 'text-base font-semibold text-slate-600'
            };
            titleEl.className = styles[level];
            titleEl.textContent = title;
            const config = BLOCKS_CONFIG[title];
            if(config) titleEl.classList.add(config.color);
            titleWrapper.appendChild(titleEl);
            headerWrapper.appendChild(titleWrapper);
            return headerWrapper;
        }

        function createTopicElement(topic, subBlockName) {
            const topicId = `${subBlockName}-${topic.id}`;
            const topicDiv = document.createElement('div');
            topicDiv.className = 'topic-card p-2 rounded-lg shadow-sm mb-2 flex items-center justify-between gap-4 transition-colors duration-300';
            topicDiv.dataset.topicId = topicId;
            topicDiv.dataset.subBlockName = subBlockName;

            const notesIcon = document.createElement('i');
            notesIcon.className = 'fas fa-note-sticky notes-icon text-lg';
            notesIcon.title = 'Añadir/Ver notas';
            notesIcon.addEventListener('click', () => showNotesModal(topicId, `${subBlockName} - Tema ${topic.id}`));

            const topicP = document.createElement('p');
            topicP.className = 'topic-text-container';
            const config = BLOCKS_CONFIG[subBlockName];
            if(config) topicP.classList.add(config.color);
            topicP.innerHTML = `${topic.id}. <span class="topic-full-name">${topic.text}</span>`;

            const ticksContainer = document.createElement('div');
            ticksContainer.className = 'flex items-start space-x-2';
            for (let i = 1; i <= 5; i++) {
                const tickContainer = document.createElement('div');
                tickContainer.className = 'tick-container';
                const tickBox = document.createElement('div');
                tickBox.className = 'tick-box';
                tickBox.dataset.vuelta = `vuelta-${i}`;
                tickBox.addEventListener('click', (e) => showSecuritySelector(e, topicId, `vuelta-${i}`));
                const tickMark = document.createElement('div');
                tickMark.className = 'tick-mark';
                tickBox.appendChild(tickMark);
                const dateSpan = document.createElement('span');
                dateSpan.className = 'tick-date';
                tickContainer.appendChild(tickBox);
                tickContainer.appendChild(dateSpan);
                ticksContainer.appendChild(tickContainer);
            }
            topicDiv.appendChild(notesIcon);
            topicDiv.appendChild(topicP);
            topicDiv.appendChild(ticksContainer);
            return topicDiv;
        }

        function updateAllCounters() {
            const selector = document.getElementById('vuelta-selector');
            if (!selector || !selector.value) return;
            const selectedVuelta = parseInt(selector.value, 10);
            renderTopSummaryTable(selectedVuelta);
        }
        
        function renderTopSummaryTable(selectedVuelta) {
            if (isNaN(selectedVuelta)) return;
            const summaryTable = document.getElementById('top-summary-table');
            const tableHead = `
                <thead class="bg-slate-200 text-xs text-slate-700 uppercase tracking-wider">
                    <tr>
                        <th class="px-6 py-3">Bloque</th>
                        <th class="px-6 py-3">Sub-bloque</th>
                        <th class="px-6 py-3 text-center">Asignados</th>
                        <th class="px-6 py-3 text-center">Estudiados</th>
                        <th class="px-6 py-3 text-center">Total Asignados</th>
                        <th class="px-6 py-3 text-center">Total Temas</th>
                    </tr>
                </thead>`;
            let tableBody = '<tbody>';
            let grandTotal = { assigned: 0, studied: 0, totalAssigned: 0, total: 0 };

            const allBlocks = {...syllabus["Materias comunes"], ...syllabus["Materias específicas"]};

            for (const mainBlockTitle in allBlocks) {
                const subBlocksOrTopics = allBlocks[mainBlockTitle];
                if (Array.isArray(subBlocksOrTopics)) {
                    const blockName = mainBlockTitle;
                    const assignedCount = document.querySelectorAll(`.topic-card[data-sub-block-name="${blockName}"] .tick-container:nth-child(${selectedVuelta}) .tick-box.assigned`).length;
                    const studiedCount = document.querySelectorAll(`.topic-card[data-sub-block-name="${blockName}"] .tick-container:nth-child(${selectedVuelta}) .tick-box.studied`).length;
                    const totalAssigned = assignedCount + studiedCount;
                    const totalTopics = subBlocksOrTopics.length;
                    
                    grandTotal.assigned += assignedCount;
                    grandTotal.studied += studiedCount;
                    grandTotal.totalAssigned += totalAssigned;
                    grandTotal.total += totalTopics;

                    const config = BLOCKS_CONFIG[blockName];
                    tableBody += `<tr class="bg-slate-50 border-b-4 border-slate-300">
                        <td colspan="2" class="px-6 py-4 font-semibold ${config.color}"><i class="fas ${config.icon} fa-fw w-5 text-center"></i>${blockName}</td>
                        <td class="px-6 py-4 text-center font-mono text-gray-600">${assignedCount}</td>
                        <td class="px-6 py-4 text-center font-mono text-green-600">${studiedCount}</td>
                        <td class="px-6 py-4 text-center font-mono">${totalAssigned}</td>
                        <td class="px-6 py-4 text-center font-mono">${totalTopics}</td>
                    </tr>`;
                } else {
                    let blockTotals = { assigned: 0, studied: 0, totalAssigned: 0, total: 0 };
                    let subRows = '';
                    const subBlockKeys = Object.keys(subBlocksOrTopics);

                    subBlockKeys.forEach((subBlockName, index) => {
                        const assignedCount = document.querySelectorAll(`.topic-card[data-sub-block-name="${subBlockName}"] .tick-container:nth-child(${selectedVuelta}) .tick-box.assigned`).length;
                        const studiedCount = document.querySelectorAll(`.topic-card[data-sub-block-name="${subBlockName}"] .tick-container:nth-child(${selectedVuelta}) .tick-box.studied`).length;
                        const totalAssigned = assignedCount + studiedCount;
                        const totalTopics = subBlocksOrTopics[subBlockName].length;
                        
                        blockTotals.assigned += assignedCount;
                        blockTotals.studied += studiedCount;
                        blockTotals.totalAssigned += totalAssigned;
                        blockTotals.total += totalTopics;

                        const config = BLOCKS_CONFIG[subBlockName];
                        subRows += `<tr class="border-t border-slate-200">
                            ${index === 0 ? `<td class="px-6 py-4 font-bold align-top" rowspan="${subBlockKeys.length}">${mainBlockTitle}</td>` : ''}
                            <td class="px-6 py-4 flex items-center gap-3 ${config.color}"><i class="fas ${config.icon} fa-fw w-5 text-center"></i><span class="font-semibold">${subBlockName}</span></td>
                            <td class="px-6 py-4 text-center font-mono text-gray-600">${assignedCount}</td>
                            <td class="px-6 py-4 text-center font-mono text-green-600">${studiedCount}</td>
                            <td class="px-6 py-4 text-center font-mono">${totalAssigned}</td>
                            <td class="px-6 py-4 text-center font-mono">${totalTopics}</td>
                        </tr>`;
                    });

                    grandTotal.assigned += blockTotals.assigned;
                    grandTotal.studied += blockTotals.studied;
                    grandTotal.totalAssigned += blockTotals.totalAssigned;
                    grandTotal.total += blockTotals.total;

                    tableBody += subRows;
                    tableBody += `<tr class="bg-slate-100 font-semibold"><td class="px-6 py-2 text-right font-bold" colspan="2">Total Bloque:</td><td class="px-6 py-2 text-center font-mono text-gray-600">${blockTotals.assigned}</td><td class="px-6 py-2 text-center font-mono text-green-600">${blockTotals.studied}</td><td class="px-6 py-2 text-center font-mono">${blockTotals.totalAssigned}</td><td class="px-6 py-2 text-center font-mono">${blockTotals.total}</td></tr>`;
                }
            }
            
            tableBody += '</tbody>';
            const tableFoot = `<tfoot class="bg-blue-100 font-bold text-blue-800 text-base">
                <tr>
                    <td colspan="2" class="px-6 py-4 text-right">TOTAL GENERAL (Vuelta ${selectedVuelta}):</td>
                    <td class="px-6 py-4 text-center font-mono text-gray-600">${grandTotal.assigned}</td>
                    <td class="px-6 py-4 text-center font-mono text-green-600">${grandTotal.studied}</td>
                    <td class="px-6 py-4 text-center font-mono">${grandTotal.totalAssigned}</td>
                    <td class="px-6 py-4 text-center font-mono">${grandTotal.total}</td>
                </tr>
            </tfoot>`;
            summaryTable.innerHTML = tableHead + tableBody + tableFoot;
        }

        async function loadProgress() {
            if (!db || !sessionId) { updateAllCounters(); return; }
            const docRef = doc(db, `artifacts/${appId}/public/data/${sessionId}/plannerState`);
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    console.log("No progress data found for this user. Initializing with empty state.");
                    plannerState = { topicState: { studiedTopics: {}, notes: {} } };
                    updateUIFromProgress();
                    return;
                }
                plannerState = docSnap.data();
                if (!plannerState || !plannerState.topicState) {
                    console.log("Planner data is empty or malformed.");
                    plannerState = { topicState: { studiedTopics: {}, notes: {} } };
                    updateUIFromProgress();
                    return;
                }
                processPlannerData();
                updateUIFromProgress();
            } catch (error) {
                console.error("Error loading progress from Firestore:", error);
                updateAllCounters();
            }
        }

        function processPlannerData() {
            progressByTopic = {};
            const { topicState: loadedTopicState, endDate, roundDurations } = plannerState;
            if (!loadedTopicState) return;

            const roundDates = {};
            if (endDate && roundDurations) {
                const deadline = new Date(endDate.split('/').reverse().join('-') + 'T00:00:00Z');
                const durations = roundDurations.map(Number);
                const totalDuration = durations.reduce((sum, d) => sum + d, 0);
                let planStartDate = new Date(deadline.getTime());
                planStartDate.setUTCDate(planStartDate.getUTCDate() - totalDuration + 1);
                
                let currentStartDate = new Date(planStartDate.getTime());
                for (let i = 0; i < 5; i++) {
                    const roundEndDate = new Date(currentStartDate.getTime());
                    roundEndDate.setUTCDate(roundEndDate.getUTCDate() + durations[i] - 1);
                    state.rounds[i] = {
                        vueltaId: `vuelta-${i + 1}`,
                        startDate: new Date(currentStartDate.getTime()),
                        endDate: roundEndDate,
                        duration: durations[i]
                    };
                    roundDates[`vuelta-${i + 1}`] = new Date(currentStartDate.getTime());
                    currentStartDate.setUTCDate(currentStartDate.getUTCDate() + durations[i]);
                }
            }

            if (loadedTopicState.studiedTopics) {
                for (const dateStr in loadedTopicState.studiedTopics) {
                    loadedTopicState.studiedTopics[dateStr].forEach(topic => {
                        // Use completionDate if available, otherwise use the key (dateStr)
                        const displayDate = topic.completionDate ? new Date(topic.completionDate + 'T00:00:00Z') : new Date(dateStr + 'T00:00:00Z');
                        progressByTopic[topic.id] = progressByTopic[topic.id] || {};
                        progressByTopic[topic.id][topic.originalVuelta] = { 
                            status: 'studied', 
                            date: `${String(displayDate.getUTCDate()).padStart(2,'0')}/${String(displayDate.getUTCMonth()+1).padStart(2,'0')}`,
                            securityLevel: topic.securityLevel || 100,
                            dateObj: dateStr // The key in the database remains the original planned date
                        };
                    });
                }
            }

            for (let i = 1; i <= 5; i++) {
                const vueltaId = `vuelta-${i}`;
                const roundState = loadedTopicState[vueltaId];
                if (roundState && roundState.assigned && roundDates[vueltaId]) {
                    const vueltaStartDate = roundDates[vueltaId];
                    for (const dayIndex in roundState.assigned) {
                        roundState.assigned[dayIndex].forEach(topic => {
                            progressByTopic[topic.id] = progressByTopic[topic.id] || {};
                            if (!progressByTopic[topic.id][vueltaId]) {
                                const assignedDate = new Date(vueltaStartDate.getTime());
                                assignedDate.setUTCDate(assignedDate.getUTCDate() + parseInt(dayIndex));
                                progressByTopic[topic.id][vueltaId] = {
                                    status: 'assigned',
                                    date: `${String(assignedDate.getUTCDate()).padStart(2,'0')}/${String(assignedDate.getUTCMonth()+1).padStart(2,'0')}`,
                                    dateObj: assignedDate.toISOString().slice(0, 10)
                                };
                            }
                        });
                    }
                }
            }
        }

        function updateUIFromProgress() {
            document.querySelectorAll('.topic-card').forEach(card => {
                const topicId = card.dataset.topicId;
                const tickContainers = card.querySelectorAll('.tick-container');
                const notesIcon = card.querySelector('.notes-icon');

                if (plannerState.topicState?.notes?.[topicId]) {
                    notesIcon.classList.add('has-notes');
                } else {
                    notesIcon.classList.remove('has-notes');
                }

                let studiedVueltasCount = 0;
                if (progressByTopic[topicId]) {
                    for (let i = 1; i <= 5; i++) {
                        if (progressByTopic[topicId][`vuelta-${i}`]?.status === 'studied') {
                            studiedVueltasCount++;
                        }
                    }
                }
                
                card.className = 'topic-card p-2 rounded-lg shadow-sm mb-2 flex items-center justify-between gap-4 transition-colors duration-300';
                if (studiedVueltasCount > 0) {
                    card.classList.add(`status-vuelta-${studiedVueltasCount}`);
                } else {
                    card.classList.add('status-not-studied');
                }
                
                tickContainers.forEach((container, index) => {
                    const tickBox = container.querySelector('.tick-box');
                    const dateSpan = container.querySelector('.tick-date');
                    const vueltaId = `vuelta-${index + 1}`;
                    
                    tickBox.className = 'tick-box';
                    dateSpan.textContent = '';

                    const progress = progressByTopic[topicId]?.[vueltaId];
                    if (progress) {
                        if (progress.status === 'studied') {
                            tickBox.classList.add('studied', `security-${progress.securityLevel}`);
                        } else if (progress.status === 'assigned') {
                            tickBox.classList.add('assigned');
                        }
                        dateSpan.textContent = progress.date;
                    }
                });
            });
            updateAllCounters();
        }

        async function savePlannerState() {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = 'Guardando...';
            statusEl.className = 'mt-2 text-sm font-semibold text-blue-600';
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/${sessionId}/plannerState`);
                await setDoc(docRef, plannerState);
                statusEl.textContent = '¡Guardado!';
                statusEl.className = 'mt-2 text-sm font-semibold text-green-600';
            } catch (error) {
                console.error("Error saving state:", error);
                statusEl.textContent = 'Error al guardar';
                statusEl.className = 'mt-2 text-sm font-semibold text-red-600';
            } finally {
                setTimeout(() => statusEl.textContent = '', 3000);
            }
        }
        
        function showSecuritySelector(event, topicId, vueltaId) {
            event.stopPropagation();
            const tickBox = event.currentTarget;

            if (!tickBox.classList.contains('studied') && !tickBox.classList.contains('assigned')) {
                return;
            }

            const isStudied = tickBox.classList.contains('studied');
            document.querySelector('.security-selector')?.remove();

            const selector = document.createElement('div');
            selector.className = 'security-selector';
            
            [20, 40, 60, 80, 100].forEach(level => {
                const option = document.createElement('div');
                option.className = 'security-option';
                option.textContent = `${level}%`;
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    updateSecurityLevel(topicId, vueltaId, level);
                    selector.remove();
                });
                selector.appendChild(option);
            });
            
            if (isStudied) {
                const unstudyOption = document.createElement('div');
                unstudyOption.className = 'security-option text-red-600';
                unstudyOption.textContent = 'No estudiado';
                unstudyOption.addEventListener('click', (e) => {
                    e.stopPropagation();
                    unstudyTopic(topicId, vueltaId);
                    selector.remove();
                });
                selector.appendChild(unstudyOption);
            }

            tickBox.appendChild(selector);

            const closeListener = (e) => {
                if (!selector.contains(e.target)) {
                    selector.remove();
                    document.removeEventListener('click', closeListener);
                }
            };
            setTimeout(() => document.addEventListener('click', closeListener), 0);
        }
        
        function unstudyTopic(topicId, vueltaId) {
            const topicProgress = progressByTopic[topicId]?.[vueltaId];
            if (!topicProgress || topicProgress.status !== 'studied') return;

            const originalPlannedDate = topicProgress.dateObj;
            const studiedDay = plannerState.topicState.studiedTopics[originalPlannedDate];
            
            if (studiedDay) {
                let unstudiedTopicData;
                const newStudiedDay = studiedDay.filter(t => {
                    if (t.id === topicId && t.originalVuelta === vueltaId) {
                        unstudiedTopicData = t;
                        return false;
                    }
                    return true;
                });

                if (!unstudiedTopicData) return;

                if (newStudiedDay.length === 0) {
                    delete plannerState.topicState.studiedTopics[originalPlannedDate];
                } else {
                    plannerState.topicState.studiedTopics[originalPlannedDate] = newStudiedDay;
                }

                const roundInfo = state.rounds.find(r => r.vueltaId === vueltaId);
                if (roundInfo) {
                    const dropDate = new Date(originalPlannedDate + 'T00:00:00Z');
                    const dayIndex = Math.round((dropDate - roundInfo.startDate) / (1000 * 60 * 60 * 24));

                    if (dayIndex >= 0 && dayIndex < roundInfo.duration) {
                        const roundState = plannerState.topicState[vueltaId];
                        if (!roundState.assigned[dayIndex]) roundState.assigned[dayIndex] = [];
                        roundState.assigned[dayIndex].push({ id: topicId, studied: false });
                    }
                }
                
                savePlannerState();
                processPlannerData();
                updateUIFromProgress();
            }
        }

        function updateSecurityLevel(topicId, vueltaId, newLevel) {
            const topicProgress = progressByTopic[topicId]?.[vueltaId];
            
            if (topicProgress && topicProgress.status === 'studied') {
                const originalPlannedDate = topicProgress.dateObj;
                const studiedDay = plannerState.topicState.studiedTopics[originalPlannedDate];
                const topicData = studiedDay?.find(t => t.id === topicId && t.originalVuelta === vueltaId);
                if (topicData) {
                    topicData.securityLevel = newLevel;
                    topicData.completionDate = new Date().toISOString().slice(0, 10);
                }
            } else if (topicProgress && topicProgress.status === 'assigned') {
                const originalPlannedDate = topicProgress.dateObj;
                if (!originalPlannedDate) {
                    console.error(`Fecha original no encontrada para ${topicId}. No se puede marcar como estudiado.`);
                    return;
                }

                const roundState = plannerState.topicState[vueltaId];
                if (roundState && roundState.assigned) {
                    for (const dayIndex in roundState.assigned) {
                        const topicIndex = roundState.assigned[dayIndex].findIndex(t => t.id === topicId);
                        if (topicIndex !== -1) {
                            roundState.assigned[dayIndex].splice(topicIndex, 1);
                            if (roundState.assigned[dayIndex].length === 0) delete roundState.assigned[dayIndex];
                            break;
                        }
                    }
                }

                if (!plannerState.topicState.studiedTopics) plannerState.topicState.studiedTopics = {};
                if (!plannerState.topicState.studiedTopics[originalPlannedDate]) {
                    plannerState.topicState.studiedTopics[originalPlannedDate] = [];
                }
                
                plannerState.topicState.studiedTopics[originalPlannedDate].push({
                    id: topicId,
                    originalVuelta: vueltaId,
                    securityLevel: newLevel,
                    studied: true,
                    completionDate: new Date().toISOString().slice(0, 10)
                });
            }

            savePlannerState();
            processPlannerData();
            updateUIFromProgress();
        }

        function showNotesModal(topicId, topicTitle) {
            const modalBackdrop = document.getElementById('notes-modal-backdrop');
            const modalTitle = document.getElementById('notes-modal-title');
            const modalTextarea = document.getElementById('notes-modal-textarea');
            const saveButton = document.getElementById('notes-modal-save');

            modalTitle.textContent = `Notas para: ${topicTitle}`;
            modalTextarea.value = plannerState.topicState?.notes?.[topicId] || '';
            
            const newSaveButton = saveButton.cloneNode(true);
            saveButton.parentNode.replaceChild(newSaveButton, saveButton);
            
            newSaveButton.onclick = () => saveNote(topicId, modalTextarea.value);

            modalBackdrop.classList.remove('hidden');
        }

        function hideNotesModal() {
            document.getElementById('notes-modal-backdrop').classList.add('hidden');
        }

        function saveNote(topicId, noteText) {
            if (!plannerState.topicState) plannerState.topicState = {};
            if (!plannerState.topicState.notes) plannerState.topicState.notes = {};
            
            plannerState.topicState.notes[topicId] = noteText;
            savePlannerState();
            hideNotesModal();
            
            const card = document.querySelector(`.topic-card[data-topic-id="${topicId}"]`);
            if (card) {
                const icon = card.querySelector('.notes-icon');
                if (noteText) {
                    icon.classList.add('has-notes');
                } else {
                    icon.classList.remove('has-notes');
                }
            }
        }

        function openCalculator() {
            const selectedVuelta = document.getElementById('vuelta-selector').value;
            const vueltaIndex = parseInt(selectedVuelta, 10);
            if(isNaN(vueltaIndex)) {
                console.error("Por favor, selecciona una vuelta válida.");
                return;
            }
            const calculatorUrl = 'https://cheradra312.github.io/CAL_PROB/';
            const params = new URLSearchParams();
            const calcData = { admin: 0, aguas: 0, carreteras: 0, transportes: 0 };
            
            document.querySelectorAll('.topic-card').forEach(card => {
                const tickBox = card.querySelector(`.tick-container:nth-child(${vueltaIndex}) .tick-box`);
                if (tickBox && tickBox.classList.contains('studied')) {
                    const subBlockName = card.dataset.subBlockName;
                    const config = BLOCKS_CONFIG[subBlockName];
                    if (config && calcData.hasOwnProperty(config.calcId)) {
                        calcData[config.calcId]++;
                    }
                }
            });

            for (const key in calcData) {
                params.append(key, calcData[key]);
            }
            window.open(`${calculatorUrl}?${params.toString()}`, '_blank');
        }

        function toggleAll(collapse) {
            document.querySelectorAll('.main-block.collapsible, .sub-block.collapsible').forEach(el => {
                el.classList.toggle('collapsed', collapse);
            });
        }
    </script>
</body>
</html>
